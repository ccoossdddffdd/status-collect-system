<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>ÁúãÈó®Áãó üêï</title>
</head>

<body>
    <div id="container"></div>
</body>

<script src="assets/jquery.min.js"></script>
<script src="assets/jquery.ba-hashchange.min.js"></script>
<script src="assets/mustache.min.js"></script>

<script id="template_item" type="x-tmpl-mustache">
    <h3>[ {{ group_name }} ]</h3>
    {{#items}}
    <div data-key="{{key}}">
        <p>
            <b>{{name}}</b> [ <small>{{key}}</small> ]
            [ {{#show_status}}{{status}}{{/show_status}} ]
        </p>
        
        {{#trigger_at}}<p style="margin:0;padding:0;"><small>{{.}}</small></p>{{/trigger_at}}
        {{^trigger_at}}<small>...</small>{{/trigger_at}}

        <hr />
    </div>
    {{/items}}
</script>

<script type="text/javascript">
    String.prototype.format = function () {
        a = this;
        for (k in arguments) {
            a = a.replace("{" + k + "}", arguments[k])
        }
        return a
    };

    function renderTo(dom_id, to_dom, data) {
        var rendered = Mustache.render($(dom_id).html(), data);
        $(to_dom).html(rendered);
    }

    function reset_key(dom) {
        var key = $(dom).parent().data('key');
        $.getJSON("/report/{0}/{1}/reset_status".format(window.group, key), function (res) {
            console.log(res);
            show_report(window.group);
        });
    }

    function show_report(group) {
        if (group == '') {
            $('#container').html('hello');
            return;
        }

        window.group = group;

        $('#container').html("loading {0} ...".format(group));
        $.getJSON('/report/' + group, function (res) {
            res['data']['show_status'] = function () {
                return function (text, render) {
                    switch (render(text)) {
                        case '0':
                            return '<span style="color: green; font-weight: bold;">Ê≠£Â∏∏</span>';
                            break;
                        case '1':
                            return '<span style="color: red; font-weight: bold;">ÂºÇÂ∏∏</span><a href="javascript: void(0);" onclick="reset_key(this);" style="font-size: 0.8em;">ÈáçÁΩÆ</a>';
                            break;
                        default:
                            return '-';
                    }
                };
            };
            renderTo('#template_item', '#container', res['data']);
        });
    };

    $(window).hashchange(function () {
        show_report(location.hash.replace('#', ''));
    });
    $(window).hashchange();
</script>

</html>